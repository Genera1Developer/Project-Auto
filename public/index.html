<!DOCTYPE html>
<html>
<head>
    <title>Secure Web Proxy</title>
    <link rel="stylesheet" href="theme/default.css">
</head>
<body>
    <h1>Secure Web Proxy</h1>
    <form id="proxyForm">
        <input type="url" id="url" placeholder="Enter URL" required>
        <button type="submit" id="goButton">Go</button>
        <button type="button" id="settingsButton">Settings</button>
    </form>
    <div id="output"></div>
    <script src="script.js"></script>
</body>
</html>

edit filepath: api/session.js
content: 
const security = require('./security');

const sessions = {}; // In-memory session storage (replace with DB in production)

// Function to create a new session
function createSession(userId) {
    const sessionId = security.generateSessionId();
    const encryptionKey = security.generateRandomKey(32); // AES-256 key

    sessions[sessionId] = {
        userId: userId,
        encryptionKey: encryptionKey,
        createdAt: new Date(),
    };

    return { sessionId, encryptionKey };
}

// Function to get session data by ID
function getSession(sessionId) {
    return sessions[sessionId] || null;
}

// Function to destroy a session
function destroySession(sessionId) {
    delete sessions[sessionId];
}

// Middleware to authenticate session (example usage in proxy.js)
function authenticateSession(req, res, next) {
    const sessionId = req.headers['x-session-id']; // Get session ID from header

    if (!sessionId) {
        return res.status(401).json({ error: 'Session ID missing' });
    }

    const session = getSession(sessionId);
    if (!session) {
        return res.status(401).json({ error: 'Invalid session ID' });
    }

    req.session = session; // Attach session to request
    next(); // Proceed to the next middleware/route handler
}

module.exports = {
    createSession,
    getSession,
    destroySession,
    authenticateSession
};

edit filepath: api/proxy.js
content: 
const https = require('https');
const http = require('http');
const { URL } = require('url');
const security = require('./security'); // Import security functions
const session = require('./session'); // Import session management

async function handleProxyRequest(req, res, settings) {
    try {
        const targetURL = req.url.slice(1); // Remove the leading slash
        if (!targetURL) {
            res.writeHead(400, { 'Content-Type': 'text/plain' });
            res.end('Target URL is missing.');
            return;
        }

        const parsedURL = new URL(targetURL);
        const options = {
            hostname: parsedURL.hostname,
            path: parsedURL.pathname + parsedURL.search,
            method: req.method,
            headers: req.headers,
        };

        // Choose http or https agent based on the target protocol
        const protocol = parsedURL.protocol === 'https:' ? https : http;

        const proxyReq = protocol.request(options, (proxyRes) => {
            let responseData = [];

            proxyRes.on('data', (chunk) => {
                responseData.push(chunk);
            });

            proxyRes.on('end', async () => {
                let buffer = Buffer.concat(responseData);
                let responseBody = buffer.toString();

                // Session Encryption
                if (settings && settings.sessionEncryption) {
                    const sessionId = req.headers['x-session-id'];
                    if (sessionId) {
                        const sessionData = session.getSession(sessionId);
                        if (sessionData) {
                            const encryptionKey = sessionData.encryptionKey;
                            const encryptedData = security.encrypt(responseBody, encryptionKey);
                            responseBody = JSON.stringify(encryptedData); // Send encrypted data as JSON
                            proxyRes.headers['content-type'] = 'application/json'; // Update content type
                        } else {
                            console.warn('Session not found, session encryption skipped.');
                        }
                    } else {
                        console.warn('Session ID missing, session encryption skipped.');
                    }
                }
                // Apply custom encryption if enabled in settings
                else if (settings && settings.encryptionType === 'custom') {
                    const encryptionKey = 'your_encryption_key'; // Replace with secure key management
                    const encryptedData = security.encrypt(responseBody, encryptionKey);
                    responseBody = JSON.stringify(encryptedData); // Send encrypted data as JSON
                    proxyRes.headers['content-type'] = 'application/json'; // Update content type
                }

                res.writeHead(proxyRes.statusCode, proxyRes.headers);
                res.end(responseBody);
            });
        });

        proxyReq.on('error', (err) => {
            console.error('Proxy request error:', err);
            res.writeHead(500, { 'Content-Type': 'text/plain' });
            res.end('Proxy request failed.');
        });

        req.on('data', (chunk) => {
            proxyReq.write(chunk);
        });

        req.on('end', () => {
            proxyReq.end();
        });

        req.on('error', (err) => {
            console.error('Client request error:', err);
            res.writeHead(500, { 'Content-Type': 'text/plain' });
            res.end('Client request failed.');
        });

    } catch (error) {
        console.error('Error handling proxy request:', error);
        res.writeHead(500, { 'Content-Type': 'text/plain' });
        res.end('Internal server error.');
    }
}

module.exports = { handleProxyRequest };

edit filepath: server.js
content: 
const http = require('http');
const { handleProxyRequest } = require('./api/proxy');
const security = require('./api/security');
const session = require('./api/session'); // Import session management
const fs = require('fs');

const hostname = '127.0.0.1';
const port = 3000;

// Load settings from a file (or use defaults)
let settings = {
    proxyHost: 'localhost',
    proxyPort: 8080,
    encryptionType: 'none',
    certificatePath: '',
    customEncryptionAlgo: '',
    sessionEncryption: false
};

try {
    const settingsData = fs.readFileSync('settings.json');
    settings = JSON.parse(settingsData);
} catch (err) {
    console.log('No settings.json file found or invalid format, using default settings.');
}

const server = http.createServer((req, res) => {
    // Basic request logging
    console.log(`Received request for: ${req.url}`);

    // Add security headers (example)
    res.setHeader('X-Content-Type-Options', 'nosniff');
    res.setHeader('X-Frame-Options', 'DENY');
    res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains'); // HTTPS only

    // Session Management (Example: create a session on first visit)
    let sessionId = req.headers['x-session-id']; // Get session ID from header

    if (!sessionId) {
        // Create a new session
        const newSession = session.createSession('user123'); // Replace 'user123' with actual user ID
        sessionId = newSession.sessionId;

        // Set the session ID as a response header for the client to store
        res.setHeader('X-Session-ID', sessionId);
    }

    // Handle the proxy request
    handleProxyRequest(req, res, settings);
});

server.listen(port, hostname, () => {
    console.log(`Server running at http://${hostname}:${port}/`);
});

// Example usage of security functions (for testing/demo purposes)
const randomKey = security.generateRandomKey(32);
console.log('Generated Random Key:', randomKey);

edit filepath: public/script.js
content: 
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('proxyForm');
    const urlInput = document.getElementById('url');
    const goButton = document.getElementById('goButton');
    const settingsButton = document.getElementById('settingsButton');
    const outputDiv = document.getElementById('output');

    // Function to get the session ID from local storage or generate a new one
    function getSessionId() {
        let sessionId = localStorage.getItem('sessionId');
        if (!sessionId) {
            // No session ID, generate a temporary one (for non-session encryption)
            sessionId = generateRandomId(24); // Generate a 24-character random ID
            localStorage.setItem('sessionId', sessionId);
        }
        return sessionId;
    }
    // Function to generate random ID
    function generateRandomId(length) {
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += characters.charAt(Math.floor(Math.random() * characters.length));
        }
        return result;
    }

    form.addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent the default form submission

        const url = urlInput.value;
        if (!url) {
            outputDiv.textContent = 'Please enter a URL.';
            return;
        }

        // Sanitize URL (basic check, more robust validation needed for production)
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            outputDiv.textContent = 'Invalid URL. Must start with http:// or https://';
            return;
        }

        // Construct the proxy URL (assuming your proxy runs on the same domain)
        const proxyUrl = '/' + url; // Prepend slash

        const sessionId = getSessionId(); // Get the session ID

        // Fetch content through the proxy
        fetch(proxyUrl, {
            headers: {
                'X-Session-ID': sessionId // Send session ID in header
            }
        })
            .then(response => {
                // Check for the new session ID in the response headers
                const newSessionId = response.headers.get('X-Session-ID');
                if (newSessionId) {
                    localStorage.setItem('sessionId', newSessionId); // Update session ID
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.text(); // Get the response as text
            })
            .then(data => {
                outputDiv.textContent = data; // Display the fetched content
            })
            .catch(error => {
                console.error('Fetch error:', error);
                outputDiv.textContent = 'Failed to load content. Check the console for errors.';
            });
    });

    settingsButton.addEventListener('click', function() {
        window.location.href = 'settings.html'; // Navigate to settings page
    });
});