<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UV - Error</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f0f0;
            margin: 0;
        }

        .container {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 500px;
        }

        h1 {
            color: #e44d26;
        }

        p {
            color: #333;
        }

        a {
            color: #007bff;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .error-url {
            word-break: break-all;
        }

        .security-warning {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }
        .hidden {
            display: none;
        }
        .security-recommendation {
            color: darkgreen;
            font-weight: normal;
            margin-top: 5px;
        }
        .error-details-pre {
            white-space: pre-wrap;
            word-break: break-all;
            text-align: left;
        }

        .error-code {
            font-family: monospace;
            background-color: #eee;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .security-info {
            color: darkorange;
            font-style: italic;
            margin-top: 10px;
        }
        .error-header {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .report-button {
            background-color: #4CAF50; /* Green */
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
        }
        .report-button:hover {
            background-color: #3e8e41;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Error</h1>
        <p id="error-message">An unexpected error occurred.</p>
        <p>Please try again later.</p>
        <a href="/">Go back to the homepage</a>
        <div id="error-url-container"></div>
        <div id="security-warnings-container"></div>
        <div id="security-info-container"></div>
        <div id="error-details-container" class="hidden">
            <h2>Error Details</h2>
            <p><span class="error-header">Type:</span> <span id="error-type"></span></p>
            <p><span class="error-header">Message:</span> <span id="error-message-detail"></span></p>
             <p><span class="error-header">URL:</span> <span id="error-url-detail"></span></p>
            <p><span class="error-header">Stack:</span> <pre class="error-details-pre"><span id="error-stack"></span></pre></p>
            <p><span class="error-header">Context:</span> <pre class="error-details-pre"><span id="error-context"></span></pre></p>
        </div>
        <button id="toggle-details">Show Error Details</button>
        <button id="report-error" class="report-button">Report Error</button>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const errorMessage = urlParams.get('message');
        const encodedURL = urlParams.get('url');
        const errorType = urlParams.get('type');
        const errorStack = urlParams.get('stack');
        const errorContext = urlParams.get('context');

        const logError = (errorData) => {
            const errorLogUrl = '/log-error';
            fetch(errorLogUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Request-ID': crypto.randomUUID()
                },
                body: JSON.stringify(errorData)
            })
            .then(response => {
                if (!response.ok) {
                    console.error('Failed to send error log:', response.status, response.statusText);
                    return response.text().then(text => {
                        console.error('Response body:', text);
                    });
                }
            })
            .catch(error => {
                console.error('Error sending error details to server:', error);
                // Retry logic (Exponential Backoff):
                const retryDelay = Math.min(5000, (Math.random() * 2000) + 1000); // Randomize delay up to 5s
                console.warn(`Retrying in ${retryDelay}ms...`);
                setTimeout(() => logError(errorData), retryDelay);
            });
        }


        if (errorMessage) {
            const sanitizedErrorMessage = DOMPurify.sanitize(errorMessage);
            document.getElementById('error-message').textContent = sanitizedErrorMessage;
            document.getElementById('error-message-detail').textContent = sanitizedErrorMessage;
        }

        let decodedURL = null;
        if (encodedURL) {
            try {
                decodedURL = decodeURIComponent(encodedURL);
                const urlDisplay = document.createElement('p');
                urlDisplay.textContent = `The following URL caused the error: `;
                urlDisplay.classList.add('error-url');

                const urlLink = document.createElement('a');
                let sanitizedDecodedURL = DOMPurify.sanitize(decodedURL, { USE_PROFILES: { html: true } });
                let securityWarnings = [];
                let securityInfo = [];

                try {
                    const parsedURL = new URL(sanitizedDecodedURL);

                    if (parsedURL.protocol !== "https:" ) {
                        securityWarnings.push("URL does not use HTTPS, which is less secure. Consider using HTTPS for enhanced security.");
                        securityInfo.push("HTTPS encrypts data transmitted between your browser and the website, protecting it from eavesdropping. Contact the website owner to enable HTTPS.");
                    }
                    else {
                        const recommendationElement = document.createElement('p');
                        recommendationElement.classList.add('security-recommendation');
                        recommendationElement.textContent = "HTTPS connection established. Your connection to the website is encrypted.";
                        document.getElementById('security-warnings-container').appendChild(recommendationElement);

                        securityInfo.push("HTTPS uses Transport Layer Security (TLS) or Secure Sockets Layer (SSL) to encrypt communication.");
                    }


                    if (!["https:", "http:"].includes(parsedURL.protocol)) {
                         securityWarnings.push(`URL uses an invalid protocol: <span class="error-code">${parsedURL.protocol}</span>. Only HTTPS and HTTP protocols are supported.`);
                         sanitizedDecodedURL = "#invalid-protocol";
                         securityInfo.push("Valid protocols ensure proper communication and prevent potential exploitation of unsupported protocols.");
                    }

                    if (parsedURL.hostname.includes("javascript:") || parsedURL.pathname.includes("javascript:")) {
                        securityWarnings.push("URL contains potentially malicious patterns (javascript:). Accessing this URL may compromise your security.");
                        sanitizedDecodedURL = "#potential-xss";
                        securityInfo.push("Malicious javascript: URLs can execute arbitrary code in your browser, leading to XSS attacks.");
                    }

                    const blockedSchemes = ['ftp:', 'file:', 'data:', 'javascript:'];
                    if (blockedSchemes.some(scheme => sanitizedDecodedURL.startsWith(scheme))) {
                        securityWarnings.push(`URL uses a potentially dangerous scheme: <span class="error-code">${sanitizedDecodedURL.substring(0, sanitizedDecodedURL.indexOf(':') + 1)}</span>. Access to this scheme is blocked for security reasons.`);
                        sanitizedDecodedURL = "#blocked-scheme";
                        securityInfo.push("Certain schemes, like file:, can expose local files, while others, like data:, can be used for data injection attacks.");
                    }

                    // Check for suspicious IP addresses (e.g., in private ranges for public URLs)
                    const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
                    if (ipRegex.test(parsedURL.hostname)) {
                        //Basic check. More sophisticated checks would involve looking up the IP.
                        if (parsedURL.hostname.startsWith("192.168.") || parsedURL.hostname.startsWith("10.") || parsedURL.hostname.startsWith("172.16.")) {
                            securityWarnings.push("URL contains a private IP address, which is unusual for a public website and could indicate a potential security issue.");
                            securityInfo.push("Private IP addresses are typically used within local networks and should not be directly exposed on the internet.");
                        }
                    }

                      //Check for URL shortening services. Can be used to hide malicious URLs.
                      const shorteningServices = ['bit.ly', 'goo.gl', 'tinyurl.com', 'ow.ly', 'is.gd'];
                      if (shorteningServices.some(service => parsedURL.hostname.includes(service))) {
                          securityWarnings.push("URL uses a URL shortening service, which can obscure the actual destination and may pose a security risk.");
                          securityInfo.push("URL shortening services can be used to hide malicious URLs or phish for credentials. Exercise caution when clicking shortened links.");
                      }

                        // Check for common phishing patterns
                      const phishingPatterns = ['/login', '/signin', '/account', '/password', '/verify'];
                      if (phishingPatterns.some(pattern => parsedURL.pathname.includes(pattern))) {
                          securityWarnings.push("URL contains common phishing patterns that may indicate a fraudulent website.");
                          securityInfo.push("Be cautious of websites asking for personal information, especially login credentials, via suspicious URLs.");
                      }


                } catch (e) {
                    console.error("URL parsing error:", e);
                    sanitizedDecodedURL = "#invalid-url";
                    securityWarnings.push("URL is invalid and could not be parsed.");
                    securityInfo.push("Invalid URLs can sometimes be crafted to exploit vulnerabilities in URL parsing libraries.");
                }

                urlLink.href = sanitizedDecodedURL;
                urlLink.textContent = decodedURL;
                urlLink.target = "_blank";
                urlLink.rel = "noopener noreferrer";

                urlDisplay.appendChild(urlLink);
                document.getElementById('error-url-container').appendChild(urlDisplay);
                document.getElementById('error-url-detail').textContent = decodedURL;


                const securityWarningsContainer = document.getElementById('security-warnings-container');
                securityWarnings.forEach(warning => {
                    const warningElement = document.createElement('p');
                    warningElement.classList.add('security-warning');
                    warningElement.innerHTML = `Security Warning: ${warning}`;
                    securityWarningsContainer.appendChild(warningElement);
                });

                const securityInfoContainer = document.getElementById('security-info-container');
                securityInfo.forEach(info => {
                    const infoElement = document.createElement('p');
                    infoElement.classList.add('security-info');
                    infoElement.textContent = info;
                    securityInfoContainer.appendChild(infoElement);
                });


            } catch (e) {
                console.error("Error decoding URL:", e);
                const urlDisplay = document.createElement('p');
                urlDisplay.textContent = `An error occurred while decoding the URL.`;
                document.getElementById('error-url-container').appendChild(urlDisplay);
                document.getElementById('error-url-detail').textContent = 'Error decoding URL';
            }
        }

        let errorData = {};

        if (errorType) {
            console.error(`Error Type: ${errorType}`);
            errorData.errorType = errorType;
            document.getElementById('error-type').textContent = errorType;
        }

        if (errorMessage) {
            errorData.errorMessage = errorMessage;
        }

        if (encodedURL) {
            errorData.errorURL = encodedURL;
            errorData.decodedURL = decodedURL;
        }

        if (errorStack) {
            console.error(`Error Stack: ${errorStack}`);
            const sanitizedErrorStack = DOMPurify.sanitize(errorStack);
            errorData.errorStack = sanitizedErrorStack;
            document.getElementById('error-stack').textContent = sanitizedErrorStack;
        }

        if (errorContext) {
            try {
                const parsedContext = JSON.parse(errorContext);
                errorData.errorContext = parsedContext;
                document.getElementById('error-context').textContent = JSON.stringify(parsedContext, null, 2);
            } catch (e) {
                console.error("Error parsing error context:", e);
                errorData.errorContext = { message: "Failed to parse context", raw: errorContext };
                document.getElementById('error-context').textContent = "Failed to parse context. Raw context: " + errorContext;
            }
        }

        if (Object.keys(errorData).length > 0) {
            try {
                logError(errorData);
            } catch (e) {
                console.error("Failed to log error:", e); // This should rarely happen now.
            }
        }

        document.getElementById('toggle-details').addEventListener('click', function() {
            const detailsContainer = document.getElementById('error-details-container');
            detailsContainer.classList.toggle('hidden');
            this.textContent = detailsContainer.classList.contains('hidden') ? 'Show Error Details' : 'Hide Error Details';
        });

        document.getElementById('report-error').addEventListener('click', function() {
            const reportData = {
                errorType: errorType,
                errorMessage: errorMessage,
                errorURL: encodedURL,
                decodedURL: decodedURL,
                errorStack: errorStack,
                errorContext: errorContext
            };

            fetch('/report-error', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Request-ID': crypto.randomUUID()
                },
                body: JSON.stringify(reportData)
            })
            .then(response => {
                if (response.ok) {
                    alert('Error reported successfully!');
                } else {
                    alert('Failed to report error.');
                    console.error('Failed to report error:', response.status, response.statusText);
                }
            })
            .catch(error => {
                console.error('Error reporting error:', error);
                alert('Error reporting error.');
            });
        });

    </script>
</body>
</html>